<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Thailand Ultimate Guide v12 (No Region Filter)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* --- STYLING --- */
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; overflow: hidden; background: #f0f0f0; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* Menu Knop */
        #toggle-btn {
            position: absolute; top: 15px; right: 15px;
            background: #fff; color: #333;
            padding: 10px 16px; border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000; border: none;
            font-weight: 700; font-size: 14px;
            cursor: pointer; display: flex; align-items: center; gap: 6px;
            transition: transform 0.2s;
        }
        #toggle-btn:active { transform: scale(0.95); }

        /* Sidebar */
        #controls {
            position: absolute; top: 0; right: 0;
            height: 100vh; width: 350px;
            background: rgba(255, 255, 255, 0.98);
            box-shadow: -5px 0 25px rgba(0,0,0,0.2);
            z-index: 2000;
            display: flex; flex-direction: column;
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #controls.active { transform: translateX(0); }

        @media (max-width: 600px) { #controls { width: 100%; max-width: 100%; } }

        .sidebar-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 20px; -webkit-overflow-scrolling: touch; }
        .sidebar-footer { padding: 15px 20px; border-top: 1px solid #eee; background: #fff; }

        h2 { margin: 0; font-size: 18px; color: #222; }
        h4 { margin: 20px 0 10px 0; font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; font-weight: 800; border-bottom: 1px solid #f0f0f0; padding-bottom: 5px; }
        .close-btn { background: none; border: none; font-size: 28px; color: #555; padding: 0 10px; cursor: pointer; }

        /* Calculator */
        .calc-box { background: #eef5ff; padding: 15px; border-radius: 12px; border: 1px solid #d0e3ff; }
        .calc-row { display: flex; gap: 10px; margin-bottom: 5px; }
        .calc-input { flex: 1; }
        .calc-input label { display: block; font-size: 10px; font-weight: bold; color: #555; margin-bottom: 3px; }
        .calc-input input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        .rate-display { font-size: 13px; color: #0056b3; font-weight: bold; text-align: center; margin: 10px 0; }
        .purchase-result { font-size: 16px; font-weight: bold; color: #28a745; text-align: center; line-height: 34px; }

        /* Inputs */
        #searchInput { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; background: #f9f9f9; box-sizing: border-box; font-size: 16px; margin-bottom: 10px; }
        .filter-group label { display: flex; align-items: center; margin-bottom: 12px; cursor: pointer; font-size: 15px; color: #333; }
        input[type="checkbox"] { width: 20px; height: 20px; margin-right: 12px; accent-color: #007bff; border-radius: 4px; }
        input[type=range] { width: 100%; margin: 10px 0; accent-color: #007bff; }
        select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; background: #f9f9f9; font-size: 14px; }
        
        /* Pins */
        .custom-pin {
            border-radius: 50% 50% 50% 0; border: 3px solid #fff; width: 40px; height: 40px;
            transform: rotate(-45deg); display: flex !important; align-items: center; justify-content: center;
            box-shadow: 2px 2px 6px rgba(0,0,0,0.3); position: relative; transition: transform 0.2s;
        }
        .pin-icon { transform: rotate(45deg); font-size: 18px; line-height: 1; }
        .rank-badge {
            position: absolute; top: -6px; right: -6px; background: #fff; color: #000; border: 2px solid #333;
            border-radius: 50%; width: 18px; height: 18px; font-size: 10px; font-weight: 900;
            display: flex; align-items: center; justify-content: center; transform: rotate(45deg); z-index: 10;
        }
        
        .marker-sight { background-color: #007bff; }
        .marker-food { background-color: #dc3545; }
        .marker-activity { background-color: #9c27b0; }
        .marker-hike { background-color: #28a745; }
        .legend-color { display: inline-block; width: 14px; height: 14px; border-radius: 50%; margin-right: 8px; flex-shrink: 0; }
        .c-sight { background-color: #007bff; } .c-food { background-color: #dc3545; } .c-act { background-color: #9c27b0; } .c-hike { background-color: #28a745; }

        /* Popup */
        .leaflet-popup-content-wrapper { border-radius: 12px; }
        .popup-content { min-width: 260px; padding-bottom: 5px; }
        .popup-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; }
        .popup-header h3 { margin: 0; font-size: 16px; color: #222; width: 85%; }
        .fav-btn { cursor: pointer; font-size: 20px; background: none; border: none; padding: 0; line-height: 1; transition: transform 0.2s; }
        .fav-btn:active { transform: scale(1.3); }
        .fav-active { color: red; } .fav-inactive { color: #ccc; }
        .desc { font-size: 13px; color: #555; margin-bottom: 10px; line-height: 1.4; }
        .meta-row { display: flex; justify-content: space-between; align-items: center; background: #f9f9f9; padding: 8px; border-radius: 6px; margin-bottom: 10px; font-size: 12px; font-weight: 600; }
        .distance-tag { display: block; font-size: 11px; color: #666; margin-top: 4px; font-weight: normal; }

        /* Knoppen */
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .full-width { grid-column: 1 / -1; }
        .popup-btn { display: flex; align-items: center; justify-content: center; text-decoration: none; border-radius: 6px; padding: 10px; font-size: 12px; font-weight: bold; color: white; gap: 6px; transition: opacity 0.2s; }
        .popup-btn:hover { opacity: 0.9; }
        .btn-google { background: #4285F4; } .btn-nav { background: #34A853; } .btn-yt { background: #FF0000; } .btn-wiki { background: #555; }
        
        .loc-btn { width: 100%; padding: 14px; background: #222; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; }
    </style>
</head>
<body>

    <button id="toggle-btn" onclick="toggleMenu()">‚öôÔ∏è Filters & Tools</button>

    <div id="controls">
        <div class="sidebar-header">
            <h2>üáπüá≠ Thai Ultimate Guide</h2>
            <button class="close-btn" onclick="toggleMenu()">√ó</button>
        </div>

        <div class="sidebar-content">
            <input type="text" id="searchInput" placeholder="üîç Zoek op naam..." onkeyup="renderMarkers()">

            <h4>üßÆ Wisselkoers & Aankoop</h4>
            <div class="calc-box">
                <div class="calc-row">
                    <div class="calc-input">
                        <label>Gepind (THB)</label>
                        <input type="number" id="calcTHB" placeholder="10000" oninput="calculateRate()">
                    </div>
                    <div class="calc-input">
                        <label>Afgeschreven (‚Ç¨)</label>
                        <input type="number" id="calcEUR" placeholder="275" oninput="calculateRate()">
                    </div>
                </div>
                <div id="rateResult" class="rate-display">Koers: 100 THB = ‚Ç¨ 2.70</div>
                
                <div style="border-top: 1px solid #ccc; margin-top: 10px; padding-top: 10px;">
                    <label style="font-size: 12px; font-weight: bold; color: #333;">Wat kost het? (Aankoop)</label>
                    <div class="calc-row">
                        <div class="calc-input">
                            <input type="number" id="purchaseTHB" placeholder="Prijs in THB" oninput="calcPurchase()">
                        </div>
                        <div class="calc-input" style="background: #fff; border: 1px solid #ccc; border-radius: 6px;">
                            <div id="purchaseResult" class="purchase-result">‚Ç¨ 0.00</div>
                        </div>
                    </div>
                </div>
            </div>

            <h4>‚ù§Ô∏è Jouw Reis</h4>
            <div class="filter-group">
                <label><input type="checkbox" id="favFilter" onchange="renderMarkers()"> Toon alleen Favorieten</label>
            </div>

            <h4>üèÜ Toplijst (1-200)</h4>
            <div style="display:flex; justify-content:space-between; font-weight:bold; color:#007bff; margin-bottom:5px;">
                <span>Top</span><span id="rankVal">200</span>
            </div>
            <input type="range" id="rankSlider" min="1" max="200" value="200" oninput="updateSliderVal(); renderMarkers()">

            <h4>Categorie√´n</h4>
            <div class="filter-group">
                <label><input type="checkbox" name="cat" value="sight" checked onchange="renderMarkers()"> <span class="legend-color c-sight"></span> Bezienswaardigheden</label>
                <label><input type="checkbox" name="cat" value="food" checked onchange="renderMarkers()"> <span class="legend-color c-food"></span> Eten & Drinken</label>
                <label><input type="checkbox" name="cat" value="activity" checked onchange="renderMarkers()"> <span class="legend-color c-act"></span> Activiteiten</label>
                <label><input type="checkbox" name="cat" value="hike" checked onchange="renderMarkers()"> <span class="legend-color c-hike"></span> Wandelingen</label>
            </div>

            <h4>Type Ervaring</h4>
            <div class="filter-group">
                <label><input type="checkbox" name="tag" value="nature" checked onchange="renderMarkers()"> üå≥ Natuur</label>
                <label><input type="checkbox" name="tag" value="culture" checked onchange="renderMarkers()"> üèõÔ∏è Cultuur & Stad</label>
            </div>
            
            <h4>Prijsklasse</h4>
            <select id="priceFilter" onchange="renderMarkers()">
                <option value="all">Alle prijzen</option>
                <option value="free">Gratis</option>
                <option value="cheap">Budget (< ‚Ç¨5)</option>
                <option value="mid">Gemiddeld (‚Ç¨5 - ‚Ç¨20)</option>
                <option value="high">Luxe (> ‚Ç¨20)</option>
            </select>
        </div>

        <div class="sidebar-footer">
            <button class="loc-btn" onclick="locateUser()">üìç Mijn Locatie</button>
            <div id="user-status" style="font-size: 11px; margin-top: 5px; color: #666; text-align: center;"></div>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="database.js"></script>

    <script>
        // --- 1. INITIALISATIE ---
        const isMobile = window.innerWidth < 600;
        const initialZoom = isMobile ? 5 : 6;
        const map = L.map('map', { zoomControl: false }).setView([13.0000, 101.5000], initialZoom);
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);

        function toggleMenu() { document.getElementById('controls').classList.toggle('active'); }
        if(isMobile) document.getElementById('controls').classList.remove('active');

        // --- 2. CHECK DATABASE ---
        if (typeof locations === 'undefined') {
            alert("‚ö†Ô∏è CRITISCHE FOUT: database.js is niet geladen. Controleer of het bestand bestaat en op dezelfde plek staat als index.html");
            var locations = []; 
        }

        // --- 3. STATE & STORAGE ---
        let favorites = JSON.parse(localStorage.getItem('thai_favs')) || [];
        let userRate = parseFloat(localStorage.getItem('thai_rate')) || 2.70; 
        let userLat = null;
        let userLng = null;
        let userMarker = null;

        if(localStorage.getItem('calc_thb')) document.getElementById('calcTHB').value = localStorage.getItem('calc_thb');
        if(localStorage.getItem('calc_eur')) document.getElementById('calcEUR').value = localStorage.getItem('calc_eur');
        updateRateDisplay(userRate);

        // --- 4. GPS LOCATIE ---
        map.locate({setView: false, watch: true, enableHighAccuracy: true});

        map.on('locationfound', function(e) {
            userLat = e.latlng.lat;
            userLng = e.latlng.lng;

            if (!userMarker) {
                userMarker = L.circleMarker(e.latlng, {
                    radius: 8, fillColor: "#4285F4", color: "#ffffff", weight: 3, opacity: 1, fillOpacity: 1
                }).addTo(map).bindPopup("Jouw Locatie");
            } else {
                userMarker.setLatLng(e.latlng);
            }
            document.getElementById('user-status').innerText = "GPS Actief ‚úÖ";
            renderMarkers(); 
        });

        map.on('locationerror', function(e) {
            document.getElementById('user-status').innerText = "GPS niet gevonden ‚ùå";
        });

        function locateUser() {
            if(userLat && userLng) {
                map.setView([userLat, userLng], 10);
            } else {
                alert("Nog geen GPS signaal. Zorg dat locatie aanstaat en refresh.");
            }
        }

        // --- 5. CALCULATOR ---
        function calculateRate() {
            const thb = parseFloat(document.getElementById('calcTHB').value);
            const eur = parseFloat(document.getElementById('calcEUR').value);
            if (thb && eur) {
                const rate100 = (eur / thb) * 100;
                userRate = rate100;
                localStorage.setItem('thai_rate', userRate);
                localStorage.setItem('calc_thb', thb);
                localStorage.setItem('calc_eur', eur);
                updateRateDisplay(rate100);
                calcPurchase();
                renderMarkers();
            }
        }

        function calcPurchase() {
            const priceThb = parseFloat(document.getElementById('purchaseTHB').value);
            if (priceThb) {
                const priceEur = (priceThb / 100) * userRate;
                document.getElementById('purchaseResult').innerText = `‚Ç¨ ${priceEur.toFixed(2)}`;
            } else {
                document.getElementById('purchaseResult').innerText = `‚Ç¨ 0.00`;
            }
        }

        function updateRateDisplay(rate) {
            document.getElementById('rateResult').innerHTML = `Koers: 100 THB = <b>‚Ç¨ ${rate.toFixed(2)}</b>`;
        }

        // --- 6. FAVORIETEN ---
        function toggleFav(id) {
            if (favorites.includes(id)) { favorites = favorites.filter(fav => fav !== id); } 
            else { favorites.push(id); }
            localStorage.setItem('thai_favs', JSON.stringify(favorites));
            
            const btn = document.getElementById(`fav-btn-${id}`);
            if(btn) {
                btn.className = favorites.includes(id) ? 'fav-btn fav-active' : 'fav-btn fav-inactive';
                btn.innerHTML = favorites.includes(id) ? '‚ù§Ô∏è' : 'ü§ç';
            }
            if(document.getElementById('favFilter').checked) renderMarkers();
        }

        // --- 7. RENDER ENGINE ---
        let markers = [];

        function renderMarkers() {
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            const maxRank = parseInt(document.getElementById('rankSlider').value);
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const showFavsOnly = document.getElementById('favFilter').checked;
            const priceFilter = document.getElementById('priceFilter').value;
            
            const catChecked = Array.from(document.querySelectorAll('input[name="cat"]:checked')).map(cb => cb.value);
            const tagChecked = Array.from(document.querySelectorAll('input[name="tag"]:checked')).map(cb => cb.value);
            // Regio filter verwijderd

            const convertPrice = (priceStr) => {
                if (priceStr.toLowerCase().includes('gratis') || priceStr.toLowerCase().includes('donatie')) return priceStr;
                let amount = parseFloat(priceStr.replace(/[^0-9,.]/g, '').replace(',', '.'));
                if (!amount) return priceStr;
                let estimatedTHB = (amount / 2.70) * 100; 
                let newEur = (estimatedTHB / 100) * userRate;
                return `‚Ç¨ ${newEur.toFixed(2)}`;
            };

            locations.forEach(loc => {
                if (loc.lat < 5 || loc.lat > 21) return; 
                
                if (showFavsOnly && !favorites.includes(loc.id)) return;
                if (!showFavsOnly && loc.rank > maxRank) return;
                if (searchTerm && !loc.name.toLowerCase().includes(searchTerm)) return;
                if (!catChecked.includes(loc.type)) return;
                if (!tagChecked.includes(loc.tag)) return;
                // Regio check verwijderd

                if (priceFilter !== 'all') {
                    if (priceFilter === 'free' && !loc.price.toLowerCase().includes('gratis')) return;
                    const isCheap = loc.price.includes('‚Ç¨ 1') || loc.price.includes('‚Ç¨ 2') || loc.price.includes('‚Ç¨ 3') || loc.price.includes('‚Ç¨ 4');
                    const isMid = !isCheap && (parseInt(loc.price.replace(/[^0-9]/g, '')) < 20);
                    if (priceFilter === 'cheap' && !isCheap && !loc.price.toLowerCase().includes('gratis')) return;
                    if (priceFilter === 'mid' && !isMid) return;
                    if (priceFilter === 'high' && (isCheap || isMid || loc.price.toLowerCase().includes('gratis'))) return;
                }

                let iconChar = '';
                if(loc.type === 'sight') iconChar = 'üì∑';
                if(loc.type === 'food') iconChar = 'üçú';
                if(loc.type === 'activity') iconChar = 'üèÑ';
                if(loc.type === 'hike') iconChar = 'ü•æ';
                
                const cssClass = `marker-${loc.type}`;
                
                const customIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div class="custom-pin ${cssClass}">
                            <div class="pin-icon">${iconChar}</div>
                            <div class="rank-badge">${loc.rank}</div>
                           </div>`,
                    iconSize: [40, 40],
                    iconAnchor: [20, 40],
                    popupAnchor: [0, -45]
                });

                const marker = L.marker([loc.lat, loc.lng], { icon: customIcon }).addTo(map);
                
                let distHtml = '';
                if(userLat) {
                    const d = getDistanceFromLatLonInKm(userLat, userLng, loc.lat, loc.lng);
                    distHtml = `<span class="distance-tag">üìè ${d.toFixed(1)} km van jou</span>`;
                }

                const isFav = favorites.includes(loc.id);
                const favIcon = isFav ? '‚ù§Ô∏è' : 'ü§ç';
                const favClass = isFav ? 'fav-active' : 'fav-inactive';
                const displayPrice = convertPrice(loc.price);
                const priceColor = displayPrice.includes('Gratis') ? 'green' : '#333';
                const regionDisplay = loc.region.charAt(0).toUpperCase() + loc.region.slice(1);

                const navUrl = `https://www.google.com/maps/search/?api=1&query=${loc.lat},${loc.lng}`;
                const infoUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc.name + " Thailand")}`;
                const ytUrl = `https://www.youtube.com/results?search_query=${encodeURIComponent(loc.name + ' Thailand vlog')}`;
                const wikiUrl = `https://en.wikipedia.org/wiki/Special:Search?search=${encodeURIComponent(loc.name)}`;

                const popupHtml = `
                    <div class="popup-content">
                        <div class="popup-header">
                            <div>
                                <div class="category-tag">${loc.type} ‚Ä¢ #${loc.rank}</div>
                                <h3>${loc.name}</h3>
                                ${distHtml}
                            </div>
                            <button id="fav-btn-${loc.id}" class="fav-btn ${favClass}" onclick="toggleFav(${loc.id})">${favIcon}</button>
                        </div>
                        <div class="desc">${loc.desc}</div>
                        <div class="meta-row">
                            <span>üìç ${regionDisplay}</span>
                            <span style="color:${priceColor}">${displayPrice}</span>
                        </div>
                        <div class="btn-grid">
                            <a href="${navUrl}" target="_blank" class="popup-btn btn-nav">üöó Navigeer</a>
                            <a href="${infoUrl}" target="_blank" class="popup-btn btn-google">‚≠ê Info</a>
                            <a href="${ytUrl}" target="_blank" class="popup-btn btn-yt">‚ñ∂ YouTube</a>
                            <a href="${wikiUrl}" target="_blank" class="popup-btn btn-wiki">üìñ Wiki</a>
                        </div>
                    </div>
                `;

                marker.bindPopup(popupHtml);
                markers.push(marker);
            });
        }

        // --- 8. HELPERS ---
        function updateSliderVal() { document.getElementById('rankVal').innerText = document.getElementById('rankSlider').value; }
        
        function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
            var R = 6371; var dLat = deg2rad(lat2-lat1); var dLon = deg2rad(lon2-lon1); 
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            return R * c; 
        }
        function deg2rad(deg) { return deg * (Math.PI/180); }

        document.getElementById('rankSlider').addEventListener('input', (e) => {
            document.getElementById('rankVal').innerText = e.target.value;
            renderMarkers();
        });
        document.querySelectorAll('input, select').forEach(el => {
            if(el.id !== 'calcTHB' && el.id !== 'calcEUR' && el.id !== 'purchaseTHB') {
                el.addEventListener('change', renderMarkers);
            }
        });
        document.getElementById('searchInput').addEventListener('keyup', renderMarkers);

        renderMarkers();

    </script>
</body>
</html>