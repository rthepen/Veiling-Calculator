<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Thailand Travel Guide v6</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* BASE STYLES */
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; overflow: hidden; background: #f0f0f0; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* 1. TOGGLE BUTTON (Main Menu) */
        #toggle-btn {
            position: absolute; top: 15px; right: 15px;
            background: #fff; color: #333;
            padding: 10px 16px; border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000; border: none;
            font-weight: 700; font-size: 14px;
            cursor: pointer; display: flex; align-items: center; gap: 6px;
            transition: transform 0.2s;
        }
        #toggle-btn:active { transform: scale(0.95); }

        /* 2. SIDEBAR / MODAL (Responsive) */
        #controls {
            position: absolute; top: 0; right: 0;
            height: 100vh; width: 350px;
            background: rgba(255, 255, 255, 0.98);
            box-shadow: -5px 0 25px rgba(0,0,0,0.2);
            z-index: 2000; /* Boven alles */
            display: flex; flex-direction: column;
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #controls.active { transform: translateX(0); }

        /* Mobiele aanpassing: Volledig scherm */
        @media (max-width: 600px) {
            #controls { width: 100%; max-width: 100%; }
        }

        /* Header & Footer van Sidebar */
        .sidebar-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 20px; -webkit-overflow-scrolling: touch; }
        .sidebar-footer { padding: 15px 20px; border-top: 1px solid #eee; background: #fff; }

        h2 { margin: 0; font-size: 18px; color: #222; }
        h4 { margin: 20px 0 10px 0; font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; font-weight: 800; border-bottom: 1px solid #f0f0f0; padding-bottom: 5px; }
        .close-btn { background: none; border: none; font-size: 28px; color: #555; padding: 0 10px; cursor: pointer; }

        /* 3. CALCULATOR STYLES */
        .calc-box { background: #eef5ff; padding: 15px; border-radius: 12px; border: 1px solid #d0e3ff; }
        .calc-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .calc-input { flex: 1; }
        .calc-input label { display: block; font-size: 10px; font-weight: bold; color: #555; margin-bottom: 3px; }
        .calc-input input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        .rate-display { font-size: 13px; color: #0056b3; font-weight: bold; text-align: center; margin-top: 5px; }
        
        /* 4. FILTERS & INPUTS */
        #searchInput { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; background: #f9f9f9; box-sizing: border-box; font-size: 16px; margin-bottom: 10px; }
        
        .filter-group label { display: flex; align-items: center; margin-bottom: 12px; cursor: pointer; font-size: 15px; color: #333; }
        input[type="checkbox"] { width: 20px; height: 20px; margin-right: 12px; accent-color: #007bff; border-radius: 4px; }
        
        /* Slider */
        input[type=range] { width: 100%; margin: 10px 0; accent-color: #007bff; }
        .slider-header { display: flex; justify-content: space-between; align-items: center; }
        .slider-val { font-weight: bold; color: #007bff; }

        /* 5. CUSTOM PINS */
        .custom-pin {
            border-radius: 50% 50% 50% 0; border: 3px solid #fff; width: 40px; height: 40px;
            transform: rotate(-45deg); display: flex !important; align-items: center; justify-content: center;
            box-shadow: 2px 2px 6px rgba(0,0,0,0.3); position: relative; transition: transform 0.2s;
        }
        .pin-icon { transform: rotate(45deg); font-size: 18px; line-height: 1; }
        .rank-badge {
            position: absolute; top: -6px; right: -6px; background: #fff; color: #000; border: 2px solid #333;
            border-radius: 50%; width: 18px; height: 18px; font-size: 10px; font-weight: 900;
            display: flex; align-items: center; justify-content: center; transform: rotate(45deg); z-index: 10;
        }
        /* Kleuren */
        .marker-sight { background-color: #007bff; }
        .marker-food { background-color: #dc3545; }
        .marker-activity { background-color: #9c27b0; }
        .marker-hike { background-color: #28a745; }
        /* Legenda bolletjes */
        .legend-color { display: inline-block; width: 14px; height: 14px; border-radius: 50%; margin-right: 8px; flex-shrink: 0; }
        .c-sight { background-color: #007bff; } .c-food { background-color: #dc3545; } .c-act { background-color: #9c27b0; } .c-hike { background-color: #28a745; }

        /* 6. POPUP & FAVORITES */
        .leaflet-popup-content-wrapper { border-radius: 12px; }
        .popup-content { min-width: 260px; padding-bottom: 5px; }
        .popup-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; }
        .popup-header h3 { margin: 0; font-size: 16px; color: #222; width: 85%; }
        
        /* Hartje */
        .fav-btn { cursor: pointer; font-size: 20px; background: none; border: none; padding: 0; line-height: 1; transition: transform 0.2s; }
        .fav-btn:active { transform: scale(1.3); }
        .fav-active { color: red; }
        .fav-inactive { color: #ccc; }

        .category-tag { font-size: 10px; font-weight: bold; color: #888; text-transform: uppercase; margin-bottom: 5px; }
        .desc { font-size: 13px; color: #555; margin-bottom: 10px; line-height: 1.4; }
        .meta-row { display: flex; justify-content: space-between; align-items: center; background: #f9f9f9; padding: 8px; border-radius: 6px; margin-bottom: 10px; font-size: 12px; font-weight: 600; }
        
        /* Knoppen */
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .full-width { grid-column: 1 / -1; }
        .popup-btn {
            display: flex; align-items: center; justify-content: center; text-decoration: none;
            border-radius: 6px; padding: 10px; font-size: 12px; font-weight: bold; color: white; gap: 6px;
        }
        .popup-btn:hover { filter: brightness(110%); }
        .btn-google { background: #4285F4; } 
        .btn-nav { background: #34A853; }
        .btn-yt { background: #FF0000; }
        .btn-wiki { background: #555; }

        /* Sidebar Footer Knop */
        .loc-btn { width: 100%; padding: 14px; background: #222; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; }
    </style>
</head>
<body>

    <button id="toggle-btn" onclick="toggleMenu()">‚öôÔ∏è Filters & Tools</button>

    <div id="controls">
        <div class="sidebar-header">
            <h2>üáπüá≠ Thai Explorer</h2>
            <button class="close-btn" onclick="toggleMenu()">√ó</button>
        </div>

        <div class="sidebar-content">
            <input type="text" id="searchInput" placeholder="üîç Zoek op naam..." onkeyup="renderMarkers()">

            <h4>üßÆ ATM & Koers Calculator</h4>
            <div class="calc-box">
                <div class="calc-row">
                    <div class="calc-input">
                        <label>Gepind (THB)</label>
                        <input type="number" id="calcTHB" placeholder="10000" oninput="calculateRate()">
                    </div>
                    <div class="calc-input">
                        <label>Afgeschreven (‚Ç¨)</label>
                        <input type="number" id="calcEUR" placeholder="275" oninput="calculateRate()">
                    </div>
                </div>
                <div id="rateResult" class="rate-display">Standaard koers: 100 THB = ‚Ç¨ 2.70</div>
            </div>

            <h4>‚ù§Ô∏è Jouw Reis</h4>
            <div class="filter-group">
                <label><input type="checkbox" id="favFilter" onchange="renderMarkers()"> Toon alleen Favorieten</label>
            </div>

            <h4>üèÜ Toplijst (1-50)</h4>
            <div class="slider-header">
                <span>Top</span>
                <span id="rankVal" class="slider-val">50</span>
            </div>
            <input type="range" id="rankSlider" min="1" max="50" value="50" oninput="updateSliderVal(); renderMarkers()">

            <h4>Categorie√´n</h4>
            <div class="filter-group">
                <label><input type="checkbox" name="cat" value="sight" checked onchange="renderMarkers()"> <span class="legend-color c-sight"></span> Bezienswaardigheden</label>
                <label><input type="checkbox" name="cat" value="food" checked onchange="renderMarkers()"> <span class="legend-color c-food"></span> Eten & Drinken</label>
                <label><input type="checkbox" name="cat" value="activity" checked onchange="renderMarkers()"> <span class="legend-color c-act"></span> Activiteiten</label>
                <label><input type="checkbox" name="cat" value="hike" checked onchange="renderMarkers()"> <span class="legend-color c-hike"></span> Wandelingen</label>
            </div>

            <h4>Type Ervaring</h4>
            <div class="filter-group">
                <label><input type="checkbox" name="tag" value="nature" checked onchange="renderMarkers()"> üå≥ Natuur</label>
                <label><input type="checkbox" name="tag" value="culture" checked onchange="renderMarkers()"> üèõÔ∏è Cultuur & Stad</label>
            </div>

            <h4>Regio's</h4>
            <div class="filter-group">
                <label><input type="checkbox" name="reg" value="bangkok" checked onchange="renderMarkers()"> Centraal & Bangkok</label>
                <label><input type="checkbox" name="reg" value="north" checked onchange="renderMarkers()"> Noord (Chiang Mai)</label>
                <label><input type="checkbox" name="reg" value="south" checked onchange="renderMarkers()"> Zuid (Eilanden)</label>
                <label><input type="checkbox" name="reg" value="west" checked onchange="renderMarkers()"> West (Kanchanaburi)</label>
                <label><input type="checkbox" name="reg" value="east" checked onchange="renderMarkers()"> Oost (Pattaya)</label>
            </div>
        </div>

        <div class="sidebar-footer">
            <button class="loc-btn" onclick="locateUser()">üìç Mijn Locatie</button>
            <div id="user-status" style="font-size: 11px; margin-top: 5px; color: #666; text-align: center;"></div>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- 1. INITIALISATIE ---
        const isMobile = window.innerWidth < 600;
        const initialZoom = isMobile ? 5 : 6;
        const map = L.map('map', { zoomControl: false }).setView([13.0000, 101.5000], initialZoom);
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);

        // Sidebar Toggle
        function toggleMenu() { document.getElementById('controls').classList.toggle('active'); }
        if(isMobile) document.getElementById('controls').classList.remove('active');

        // --- 2. STATE & STORAGE (Favorieten & Koers) ---
        let favorites = JSON.parse(localStorage.getItem('thai_favs')) || [];
        let userRate = parseFloat(localStorage.getItem('thai_rate')) || 0; // 0 = default (2.70 per 100)
        let userLat = null;
        let userLng = null;

        // Vul calculator in als er data is
        if(localStorage.getItem('calc_thb')) document.getElementById('calcTHB').value = localStorage.getItem('calc_thb');
        if(localStorage.getItem('calc_eur')) document.getElementById('calcEUR').value = localStorage.getItem('calc_eur');
        if(userRate > 0) updateRateDisplay(userRate);

        // Calculator Logica
        function calculateRate() {
            const thb = parseFloat(document.getElementById('calcTHB').value);
            const eur = parseFloat(document.getElementById('calcEUR').value);
            
            if (thb && eur) {
                // Hoeveel EUR kost 100 THB?
                // Voorbeeld: 10000 THB voor 275 EUR -> 1 THB = 0.0275 EUR -> 100 THB = 2.75 EUR
                const rate100 = (eur / thb) * 100;
                userRate = rate100;
                
                // Opslaan
                localStorage.setItem('thai_rate', userRate);
                localStorage.setItem('calc_thb', thb);
                localStorage.setItem('calc_eur', eur);
                
                updateRateDisplay(rate100);
                renderMarkers(); // Update prijzen op kaart
            }
        }

        function updateRateDisplay(rate) {
            document.getElementById('rateResult').innerHTML = `Jouw koers: 100 THB = <b>‚Ç¨ ${rate.toFixed(2)}</b>`;
        }

        // Favorieten Logica
        function toggleFav(id) {
            if (favorites.includes(id)) {
                favorites = favorites.filter(fav => fav !== id);
            } else {
                favorites.push(id);
            }
            localStorage.setItem('thai_favs', JSON.stringify(favorites));
            
            // Update icoontje in huidige popup zonder te sluiten
            const btn = document.getElementById(`fav-btn-${id}`);
            if(btn) {
                btn.className = favorites.includes(id) ? 'fav-btn fav-active' : 'fav-btn fav-inactive';
                btn.innerHTML = favorites.includes(id) ? '‚ù§Ô∏è' : 'ü§ç';
            }
            
            // Als filter aanstaat, refresh kaart
            if(document.getElementById('favFilter').checked) renderMarkers();
        }

        // --- 3. DATASET (Met ID voor favorites) ---
        // Let op: Unieke ID toegevoegd aan items
        const locations = [
            // BEZIENSWAARDIGHEDEN
            { id: 101, rank: 1, type: 'sight', tag: 'culture', region: 'bangkok', name: "The Grand Palace", lat: 13.7500, lng: 100.4915, price: "‚Ç¨ 13,50", desc: "H√©t symbool van Thailand." },
            { id: 102, rank: 2, type: 'sight', tag: 'culture', region: 'bangkok', name: "Wat Arun", lat: 13.7437, lng: 100.4888, price: "‚Ç¨ 5,40", desc: "Tempel van de Dageraad." },
            { id: 103, rank: 3, type: 'sight', tag: 'culture', region: 'bangkok', name: "Ayutthaya Historical Park", lat: 14.3532, lng: 100.5684, price: "‚Ç¨ 1,35", desc: "Oude tempelru√Ønes." },
            { id: 104, rank: 4, type: 'sight', tag: 'nature', region: 'south', name: "Maya Bay (Phi Phi)", lat: 7.6775, lng: 98.7663, price: "‚Ç¨ 10,80", desc: "Beroemd strand uit 'The Beach'." },
            { id: 105, rank: 5, type: 'sight', tag: 'culture', region: 'north', name: "Wat Phra That Doi Suthep", lat: 18.8048, lng: 98.9216, price: "‚Ç¨ 0,80", desc: "Heilige bergtempel." },
            { id: 106, rank: 6, type: 'sight', tag: 'nature', region: 'south', name: "Khao Sok National Park", lat: 8.9135, lng: 98.5309, price: "‚Ç¨ 8,10", desc: "Oerwoud en drijvende huisjes." },
            { id: 107, rank: 7, type: 'sight', tag: 'culture', region: 'bangkok', name: "Damnoen Saduak Market", lat: 13.5195, lng: 99.9577, price: "Gratis", desc: "Drijvende markt." },
            { id: 108, rank: 8, type: 'sight', tag: 'culture', region: 'bangkok', name: "Wat Pho", lat: 13.7465, lng: 100.4933, price: "‚Ç¨ 8,10", desc: "Liggende Boeddha." },
            { id: 109, rank: 9, type: 'sight', tag: 'culture', region: 'west', name: "Bridge over River Kwai", lat: 14.0410, lng: 99.5042, price: "Gratis", desc: "WO2 Historie." },
            { id: 110, rank: 10, type: 'sight', tag: 'nature', region: 'south', name: "Railay Beach", lat: 8.0110, lng: 98.8373, price: "Gratis", desc: "Kalksteenkliffen strand." },
            { id: 112, rank: 12, type: 'sight', tag: 'culture', region: 'north', name: "Wat Rong Khun", lat: 19.8243, lng: 99.7632, price: "‚Ç¨ 2,70", desc: "De Witte Tempel." },
            { id: 113, rank: 13, type: 'sight', tag: 'culture', region: 'north', name: "Sukhothai Historical Park", lat: 17.0163, lng: 99.7036, price: "‚Ç¨ 2,70", desc: "Oerste hoofdstad." },
            { id: 118, rank: 18, type: 'sight', tag: 'culture', region: 'east', name: "Sanctuary of Truth", lat: 12.9727, lng: 100.8891, price: "‚Ç¨ 13,50", desc: "Houten tempel aan zee." },
            { id: 125, rank: 25, type: 'sight', tag: 'culture', region: 'bangkok', name: "Jim Thompson House", lat: 13.7495, lng: 100.5283, price: "‚Ç¨ 5,40", desc: "Thais houten huis & zijde." },
            
            // ETEN
            { id: 201, rank: 1, type: 'food', tag: 'culture', region: 'bangkok', name: "Raan Jay Fai", lat: 13.7525, lng: 100.5048, price: "‚Ç¨ 20+", desc: "Michelin streetfood (Krabomelet)." },
            { id: 202, rank: 2, type: 'food', tag: 'culture', region: 'bangkok', name: "Jeh O Chula", lat: 13.7425, lng: 100.5225, price: "‚Ç¨ 6,75", desc: "Tom Yum Mama Noodles." },
            { id: 203, rank: 3, type: 'food', tag: 'culture', region: 'north', name: "Khao Soi Khun Yai", lat: 18.7953, lng: 98.9831, price: "‚Ç¨ 1,35", desc: "Beste Khao Soi in Chiang Mai." },
            { id: 204, rank: 4, type: 'food', tag: 'culture', region: 'bangkok', name: "Thipsamai Pad Thai", lat: 13.7528, lng: 100.5048, price: "‚Ç¨ 3,50", desc: "Beroemdste Pad Thai." },
            { id: 205, rank: 5, type: 'food', tag: 'culture', region: 'bangkok', name: "Wattana Panich", lat: 13.7341, lng: 100.5876, price: "‚Ç¨ 2,70", desc: "50-jaar oude soepbouillon." },
            { id: 206, rank: 6, type: 'food', tag: 'culture', region: 'south', name: "Tu Kab Khao", lat: 7.8836, lng: 98.3880, price: "‚Ç¨ 12,00", desc: "Zuid-Thais in Phuket Town." },
            { id: 210, rank: 10, type: 'food', tag: 'culture', region: 'north', name: "Khao Soi Mae Sai", lat: 18.7996, lng: 98.9752, price: "‚Ç¨ 1,35", desc: "Rijke bouillon Khao Soi." },
            { id: 212, rank: 12, type: 'food', tag: 'culture', region: 'bangkok', name: "Jok Prince", lat: 13.7196, lng: 100.5153, price: "‚Ç¨ 1,50", desc: "Rijstepap ontbijt." },
            { id: 222, rank: 22, type: 'food', tag: 'culture', region: 'bangkok', name: "T&K Seafood", lat: 13.7410, lng: 100.5085, price: "‚Ç¨ 10,00", desc: "Street seafood in Chinatown." },
            { id: 230, rank: 30, type: 'food', tag: 'culture', region: 'bangkok', name: "Pier 21 Food Court", lat: 13.7376, lng: 100.5603, price: "‚Ç¨ 1,50", desc: "Goedkoopste schone streetfood." },
            { id: 232, rank: 32, type: 'food', tag: 'culture', region: 'south', name: "Kodam Kitchen", lat: 8.0336, lng: 98.8286, price: "‚Ç¨ 6,00", desc: "Beste in Ao Nang." },

            // ACTIVITEITEN
            { id: 301, rank: 1, type: 'activity', tag: 'culture', region: 'bangkok', name: "Thaise Massage (Wat Pho)", lat: 13.7460, lng: 100.4930, price: "‚Ç¨ 8,00", desc: "De bron van de massage." },
            { id: 304, rank: 4, type: 'activity', tag: 'nature', region: 'north', name: "Olifantenreservaat (ENP)", lat: 19.2155, lng: 98.8606, price: "‚Ç¨ 60,00", desc: "Ethische opvang, no riding." },
            { id: 305, rank: 5, type: 'activity', tag: 'culture', region: 'bangkok', name: "Kookcursus (Silom)", lat: 13.7242, lng: 100.5234, price: "‚Ç¨ 30,00", desc: "Leer curry maken." },
            { id: 315, rank: 15, type: 'activity', tag: 'culture', region: 'south', name: "Full Moon Party", lat: 9.6766, lng: 100.0631, price: "‚Ç¨ 3,00", desc: "Strandfeest Koh Phangan." },
            { id: 328, rank: 28, type: 'activity', tag: 'culture', region: 'bangkok', name: "Sak Yant Tattoo", lat: 13.9168, lng: 100.2078, price: "Donatie", desc: "Heilige tatoeage (Wat Bang Phra)." },
            { id: 330, rank: 30, type: 'activity', tag: 'culture', region: 'bangkok', name: "Chatuchak Market", lat: 13.7998, lng: 100.5504, price: "Gratis", desc: "Grootste weekendmarkt." },
            { id: 340, rank: 40, type: 'activity', tag: 'nature', region: 'bangkok', name: "Varanen in Lumpini Park", lat: 13.7314, lng: 100.5414, price: "Gratis", desc: "Stadspark vol dieren." },
            { id: 350, rank: 50, type: 'activity', tag: 'culture', region: 'bangkok', name: "Ancient City", lat: 13.5390, lng: 100.6226, price: "‚Ç¨ 20,00", desc: "Thailand in het klein." },

            // WANDELINGEN
            { id: 401, rank: 1, type: 'hike', tag: 'nature', region: 'north', name: "Kew Mae Pan Nature Trail", lat: 18.5527, lng: 98.4801, price: "‚Ç¨ 5,50", desc: "Boven de wolken op Doi Inthanon." },
            { id: 402, rank: 2, type: 'hike', tag: 'nature', region: 'south', name: "Dragon Crest (Ngorn Nak)", lat: 8.0973, lng: 98.7494, price: "Gratis", desc: "Spectaculair uitzicht Krabi." },
            { id: 403, rank: 3, type: 'hike', tag: 'nature', region: 'north', name: "Monk's Trail (Wat Pha Lat)", lat: 18.7963, lng: 98.9435, price: "Gratis", desc: "Junglepad naar tempel." },
            { id: 404, rank: 4, type: 'hike', tag: 'nature', region: 'south', name: "Phraya Nakhon Cave", lat: 12.2059, lng: 100.0102, price: "‚Ç¨ 5,40", desc: "Grot met paviljoen." },
            { id: 405, rank: 5, type: 'hike', tag: 'nature', region: 'west', name: "Erawan Waterfalls", lat: 14.3755, lng: 99.1440, price: "‚Ç¨ 8,10", desc: "7 waterval niveaus." },
            { id: 406, rank: 6, type: 'hike', tag: 'nature', region: 'west', name: "Khao Chang Phueak", lat: 14.6543, lng: 98.5413, price: "‚Ç¨ 10,00", desc: "Gevaarlijke bergrug." },
            { id: 408, rank: 8, type: 'hike', tag: 'nature', region: 'north', name: "Phu Chi Fa", lat: 19.8500, lng: 100.4460, price: "Gratis", desc: "Zonsopgang op klif." },
            { id: 409, rank: 9, type: 'hike', tag: 'culture', region: 'south', name: "Tiger Cave Temple (1237 treden)", lat: 8.1239, lng: 98.9251, price: "Gratis", desc: "Zware klim naar Boeddha." },
            { id: 413, rank: 13, type: 'hike', tag: 'nature', region: 'north', name: "Pai Canyon", lat: 19.3060, lng: 98.4526, price: "Gratis", desc: "Smalle zandrichels." },
            { id: 414, rank: 14, type: 'hike', tag: 'nature', region: 'north', name: "Sticky Waterfalls", lat: 19.0833, lng: 99.0833, price: "Gratis", desc: "In de waterval lopen." },
            { id: 427, rank: 27, type: 'hike', tag: 'nature', region: 'bangkok', name: "Bang Kachao (Green Lung)", lat: 13.6828, lng: 100.5600, price: "Gratis", desc: "Fietsen/lopen in stad." }
        ];

        let markers = [];

        // --- 4. RENDER FUNCTIE ---
        function renderMarkers() {
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            const maxRank = parseInt(document.getElementById('rankSlider').value);
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const showFavsOnly = document.getElementById('favFilter').checked;
            
            const catChecked = Array.from(document.querySelectorAll('input[name="cat"]:checked')).map(cb => cb.value);
            const regChecked = Array.from(document.querySelectorAll('input[name="reg"]:checked')).map(cb => cb.value);
            const tagChecked = Array.from(document.querySelectorAll('input[name="tag"]:checked')).map(cb => cb.value);

            // Bepaal huidige omrekenfactor (Standaard DB is gebaseerd op 100 THB = 2.70 EUR)
            // Als userRate 0 is, gebruiken we standaard (geen aanpassing).
            // Als userRate > 0, rekenen we om:
            // Nieuwe Prijs = (Oude Prijs / 2.70) * UserRate
            const convertPrice = (priceStr) => {
                if (userRate === 0 || priceStr.toLowerCase().includes('gratis') || priceStr.toLowerCase().includes('donatie')) return priceStr;
                
                // Haal getal uit string (bv "‚Ç¨ 13,50" -> 13.50)
                let amount = parseFloat(priceStr.replace(/[^0-9,.]/g, '').replace(',', '.'));
                if (!amount) return priceStr;

                // 1. Reken terug naar THB (100 THB = 2.70 EUR -> 1 EUR = 37 THB)
                let estimatedTHB = (amount / 2.70) * 100;

                // 2. Reken naar Nieuwe EUR met userRate (100 THB = userRate)
                let newEur = (estimatedTHB / 100) * userRate;

                return `‚Ç¨ ${newEur.toFixed(2)}`;
            };

            locations.forEach(loc => {
                if (loc.lat < 5 || loc.lat > 21) return;
                
                // Filters
                if (showFavsOnly && !favorites.includes(loc.id)) return;
                if (!showFavsOnly && loc.rank > maxRank) return; // Ranking filter negeren als je in favorites zit? Nee, laat maar werken.
                if (searchTerm && !loc.name.toLowerCase().includes(searchTerm)) return;
                if (!catChecked.includes(loc.type)) return;
                if (!regChecked.includes(loc.region)) return;
                if (!tagChecked.includes(loc.tag)) return;

                // Icon & Kleur
                let iconChar = '';
                if(loc.type === 'sight') iconChar = 'üì∑';
                if(loc.type === 'food') iconChar = 'üçú';
                if(loc.type === 'activity') iconChar = 'üèÑ';
                if(loc.type === 'hike') iconChar = 'ü•æ';
                
                const cssClass = `marker-${loc.type}`;
                
                const customIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div class="custom-pin ${cssClass}">
                            <div class="pin-icon">${iconChar}</div>
                            <div class="rank-badge">${loc.rank}</div>
                           </div>`,
                    iconSize: [40, 40],
                    iconAnchor: [20, 40],
                    popupAnchor: [0, -45]
                });

                const marker = L.marker([loc.lat, loc.lng], { icon: customIcon }).addTo(map);
                
                // Afstand
                let distHtml = '';
                if(userLat) {
                    const d = getDistanceFromLatLonInKm(userLat, userLng, loc.lat, loc.lng);
                    distHtml = `<span class="distance-tag">üìè ${d.toFixed(1)} km</span>`;
                }

                // Favoriet Icoon
                const isFav = favorites.includes(loc.id);
                const favIcon = isFav ? '‚ù§Ô∏è' : 'ü§ç';
                const favClass = isFav ? 'fav-active' : 'fav-inactive';

                // Prijs berekenen
                const displayPrice = convertPrice(loc.price);
                const priceColor = displayPrice.includes('Gratis') ? 'green' : '#333';

                // Links
                const navUrl = `https://www.google.com/maps/dir/?api=1&destination=${loc.lat},${loc.lng}`;
                const infoUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc.name + " Thailand")}`; // Google Maps Business Page search
                const ytUrl = `https://www.youtube.com/results?search_query=${encodeURIComponent(loc.name + ' Thailand vlog')}`;
                const wikiUrl = `https://en.wikipedia.org/wiki/Special:Search?search=${encodeURIComponent(loc.name)}`;

                const popupHtml = `
                    <div class="popup-content">
                        <div class="popup-header">
                            <div>
                                <div class="category-tag">${loc.type} ‚Ä¢ #${loc.rank}</div>
                                <h3>${loc.name}</h3>
                            </div>
                            <button id="fav-btn-${loc.id}" class="fav-btn ${favClass}" onclick="toggleFav(${loc.id})">${favIcon}</button>
                        </div>
                        ${distHtml}
                        <div class="desc">${loc.desc}</div>
                        
                        <div class="meta-row">
                            <span>üìç ${loc.region.charAt(0).toUpperCase() + loc.region.slice(1)}</span>
                            <span style="color:${priceColor}">${displayPrice}</span>
                        </div>

                        <div class="btn-grid">
                            <a href="${infoUrl}" target="_blank" class="popup-btn btn-google full-width">‚≠ê Info & Reviews</a>
                            <a href="${navUrl}" target="_blank" class="popup-btn btn-nav">üöó Navigeer</a>
                            <a href="${ytUrl}" target="_blank" class="popup-btn btn-yt">‚ñ∂ YouTube</a>
                            <a href="${wikiUrl}" target="_blank" class="popup-btn btn-wiki full-width">üìñ Wikipedia</a>
                        </div>
                    </div>
                `;

                marker.bindPopup(popupHtml);
                markers.push(marker);
            });
        }

        // --- HELPERS ---
        function updateSliderVal() { document.getElementById('rankVal').innerText = document.getElementById('rankSlider').value; }
        
        function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
            var R = 6371; var dLat = deg2rad(lat2-lat1); var dLon = deg2rad(lon2-lon1); 
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            return R * c; 
        }
        function deg2rad(deg) { return deg * (Math.PI/180); }

        function locateUser() {
            const s = document.getElementById('user-status');
            if(!navigator.geolocation) { s.innerText = "Geen GPS"; return; }
            s.innerText = "Zoeken...";
            navigator.geolocation.getCurrentPosition(p => {
                userLat = p.coords.latitude; userLng = p.coords.longitude;
                map.eachLayer(l => { if(l.options.title === 'user') map.removeLayer(l); });
                L.marker([userLat, userLng], {title:'user'}).addTo(map).bindPopup("Jij").openPopup();
                map.setView([userLat, userLng], 10);
                s.innerText = "Gevonden!";
                renderMarkers();
            }, () => { s.innerText = "Fout bij locatie."; });
        }

        renderMarkers();
    </script>
</body>
</html>
